!function(){const e={base_url:null,setBaseUrl:t=>e.base_url=t,makeTagInDom:(t,a)=>{const o=document.createElement("div");return o.classList.add("tag"),o.style.backgroundColor=t.color,o.textContent=t.title,o.setAttribute("label_id",t.id),o.setAttribute("card_id",a),o.addEventListener("dblclick",e.disassociateTag),o},showHandleTagsModal:async function(){const t=document.getElementById("addAndEditTagModal");try{const a=await fetch(e.base_url+"/label"),o=await a.json();if(!a.ok)throw o;{const a=document.createElement("div");a.classList.add("editTagForm");for(const t of o){const o=e.makeEditTagForm(t);a.appendChild(o)}t.querySelector(".editTagForm").replaceWith(a),t.classList.add("is-active")}}catch(a){alert("Impossible de r\xe9cup\xe9rer les tags"),console.error(a)}},makeEditTagForm:function(t){const a=document.getElementById("newTagForm"),o=document.importNode(a,!0);o.setAttribute("id",null),o.classList.add("editTag"),o.querySelector('[name="title"]').value=t.title,o.querySelector('[name="color"]').value=t.color,o.setAttribute("label_id",t.id),o.addEventListener("submit",e.handleEditTag);const r=document.createElement("div");return r.classList.add("button","is-small","is-danger"),r.textContent="Supprimer",r.addEventListener("click",e.handleDeleteTag),o.querySelector(".field").appendChild(r),o},handleAddNewTagForm:async function(t){t.preventDefault();const a=new FormData(t.target);try{const t=await fetch(e.base_url+"/label",{method:"POST",body:a});if(!t.ok)throw await t.json()}catch(o){alert("Impossible d'ajouter le tags"),console.error(o)}},handleEditTag:async function(t){t.preventDefault();const a=new FormData(t.target),o=t.target.getAttribute("label_id");try{const t=await fetch(`${e.base_url}/label/${o}`,{method:"PATCH",body:a}),r=await t.json();if(!t.ok)throw r;{const e=document.querySelectorAll(`[label_id="${o}"]`);for(const t of e)t.textContent=r.title,t.style.backgroundColor=r.color}}catch(r){alert("Impossible de modifier le tag"),console.error(r)}document.getElementById("addAndEditTagModal").classList.remove("is-active")},handleDeleteTag:async t=>{const a=t.target.closest("form").getAttribute("label_id");try{let t=await fetch(e.base_url+"/label/"+a,{method:"DELETE"});if(!t.ok)throw await t.json();{let e=document.querySelectorAll(`[label_id="${a}"]`);for(let t of e)t.remove()}}catch(o){alert("Impossible de supprimer le tag"),console.error(o)}document.getElementById("addAndEditTagModal").classList.remove("is-active")},showAssociateModal:async t=>{const a=t.target.closest(".box").getAttribute("card_id"),o=document.getElementById("associateTagModal");try{let t=await fetch(e.base_url+"/label");if(!t.ok)throw await t.json();{let r=await t.json(),l=document.createElement("section");l.classList.add("modal-card-body");for(let t of r){let o=e.makeTagInDom(t,a);o.addEventListener("click",e.handleAssociateTag),l.appendChild(o)}o.querySelector(".modal-card-body").replaceWith(l),o.classList.add("is-active")}}catch(r){alert("Impossible de r\xe9cup\xe9rer les tags"),console.error(r)}},handleAssociateTag:async t=>{const a=t.target.getAttribute("label_id"),o=t.target.getAttribute("card_id");try{let t=await fetch(`${e.base_url}/card/${o}/label/${a}`,{method:"POST"});if(!t.ok)throw await t.json();{let a=await t.json(),o=document.querySelectorAll(`[card_id="${a.id}"] .tag`);for(let e of o)e.remove();let r=document.querySelector(`[card_id="${a.id}"] .tags`);for(let t of a.labels){let o=e.makeTagInDom(t,a.id);r.appendChild(o)}}}catch(r){alert("Impossible d'associer le tag"),console.error(r)}document.getElementById("associateTagModal").classList.remove("is-active")},disassociateTag:async t=>{const a=t.target.getAttribute("label_id"),o=t.target.getAttribute("card_id");try{let r=await fetch(`${e.base_url}/card/${o}/label/${a}`,{method:"DELETE"});if(!r.ok)throw await r.json();t.target.remove()}catch(r){alert("Impossible de d\xe9sassocier le tag"),console.error(r)}}};var t=e;const a={base_url:null,setBaseUrl:e=>a.base_url=e,showAddCardModal:function(e){const t=e.target.closest(".panel").getAttribute("list_id"),a=document.getElementById("addCardModal");a.classList.add("is-active"),a.querySelector("#list_id").value=t,console.log("listId dans le formulaire : ",a.querySelector("#list_id").value)},handleAddCardForm:async function(e){e.preventDefault();const t=new FormData(e.target);try{const e=await fetch(a.base_url+"/card",{method:"POST",body:t}),o=await e.json();if(200!==e.status)throw o;a.makeCardInDOM(o)}catch(o){alert("Impossible dajouter la carte"),console.error(o)}},makeCardInDOM:function(e){console.log("makeCardInDOM",e.title,e.list_id);const o=document.getElementById("cardTemplate"),r=document.importNode(o.content,!0);r.querySelector(".column").textContent=e.title,r.querySelector(".fa-pencil-alt").closest("a").addEventListener("click",a.showCardNameForm),r.querySelector(".fa-trash-alt").closest("a").addEventListener("click",a.deleteCard),r.querySelector(".button--add-tag").addEventListener("click",t.showAssociateModal);const l=r.querySelector(".box");l.setAttribute("card_id",e.id),l.style.backgroundColor=e.color,l.querySelector("form").addEventListener("submit",a.handleCardNameForm),document.querySelector(`[list_id="${e.list_id}"]`).querySelector(".panel-block").appendChild(r)},deleteCard:async function(e){if(e.preventDefault(),!confirm("Supprimer cette carte"))return;const t=e.target.closest(".box"),o=t.getAttribute("card_id");console.log("Carte \xe0 supprimer : ",o);try{const e=await fetch(`${a.base_url}/card/${o}`,{method:"DELETE"});if(!e.ok)throw await e.json();t.remove()}catch(r){alert("Impossible de supprimer la carte"),console.error(r)}},showCardNameForm:function(e){const t=e.target.closest(".box").querySelector(".column");t.classList.add("is-hidden");const o=e.target.closest(".box").querySelector("form");o.querySelector('input[name="title"]').value=t.textContent,o.querySelector('input[name="color"]').value=a.rgb2hex(e.target.closest(".box").style.backgroundColor),o.classList.remove("is-hidden")},handleCardNameForm:async function(e){e.preventDefault();const t=new FormData(e.target),o=e.target.closest(".box").querySelector(".column"),r=e.target.closest(".box").getAttribute("card_id");try{const l=await fetch(`${a.base_url}/card/${r}`,{method:"PATCH",body:t}),s=await l.json();if(200!==l.status)throw s;o.textContent=s.title,e.target.closest(".box").style.backgroundColor=s.color}catch(l){alert("Impossible de modifier la carte"),console.error(l)}e.target.classList.add("is-hidden"),o.classList.remove("is-hidden")},rgb2hex:e=>{if("#"===e.charAt(0))return e;let t=e.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)$/);function a(e){return("0"+parseInt(e).toString(16)).slice(-2)}return"#"+a(t[1])+a(t[2])+a(t[3])}};var o=a;const r={base_url:null,setBaseUrl:e=>r.base_url=e,showAddListModal:function(){document.getElementById("addListModal").classList.add("is-active")},handleAddListForm:async function(e){e.preventDefault();const t=new FormData(e.target);try{const e=await fetch(r.base_url+"/list",{method:"POST",body:t}),a=await e.json();if(console.log(a),200!==e.status)throw a;r.makeListInDOM(a)}catch(a){alert("Impossible d'ajouter la liste"),console.error(a)}},makeListInDOM:function(e){console.log("In makeListInDOM",e.title);const t=document.getElementById("listTemplate"),a=document.importNode(t.content,!0),l=a.querySelector("h2");l.textContent=e.title,l.addEventListener("dblclick",r.showListNameForm);const s=a.querySelector("[list_id]");s.setAttribute("list_id",e.id),a.querySelector("form").addEventListener("submit",r.handleListNameForm),s.querySelector('[name="list_id"]').value=e.id,s.querySelector(".button--add-card").addEventListener("click",o.showAddCardModal),s.querySelector(".button--delete-list").addEventListener("click",r.deleteList);let d=a.querySelector(".panel-block");new Sortable(d,{group:"list",draggable:".box",onEnd:r.handleDropCard});const n=document.querySelector(".panel");n?n.before(a):document.querySelector(".card-lists").appendChild(a)},deleteList:async function(e){e.preventDefault();const t=e.target.closest(".panel"),a=t.getAttribute("list_id");if(t.querySelector(".box"))alert("Impossible de supprimer une liste non vide");else if(confirm("Supprimer cette liste ?"))try{const e=await fetch(`${r.base_url}/list/${a}`,{method:"DELETE"});if(!e.ok)throw await e.json();t.remove()}catch(o){alert("Impossible de supprimer la liste"),console.error(o)}},showListNameForm:function(e){e.target.classList.add("is-hidden");const t=e.target.closest(".panel").querySelector("form");t.querySelector('input[name="title"]').value=e.target.textContent,t.classList.remove("is-hidden")},handleListNameForm:async function(e){e.preventDefault();const t=new FormData(e.target),a=e.target.closest(".panel");try{const e=await fetch(`${r.base_url}/list/${t.get("list_id")}`,{method:"PATCH",body:t}),o=await e.json();if(200!==e.status)throw o;a.querySelector("h2").textContent=o.title}catch(o){alert("Impossible de modifier la liste"),console.error(o)}e.target.classList.add("is-hidden"),a.querySelector("h2").classList.remove("is-hidden")},updateAllLists:function(){document.querySelectorAll(".panel").forEach((e,t)=>{const a=e.getAttribute("list_id");let o=new FormData;o.set("position",t),fetch(r.base_url+"/list/"+a,{method:"PATCH",body:o})})},handleDropList:function(){r.updateAllLists()},updateAllCards:(e,t)=>{e.forEach((e,a)=>{const r=e.getAttribute("card_id");let l=new FormData;l.set("position",a),l.set("list_id",t),fetch(o.base_url+"/card/"+r,{method:"PATCH",body:l})})},handleDropCard:e=>{let t=e.from,a=e.to,o=t.querySelectorAll(".box"),l=t.closest(".panel").getAttribute("list_id");r.updateAllCards(o,l),t!==a&&(o=a.querySelectorAll(".box"),l=a.closest(".panel").getAttribute("list_id"),r.updateAllCards(o,l))}};var l=r,s={base_url:"",init:async function(){console.log("app.init !"),l.setBaseUrl(s.base_url),o.setBaseUrl(s.base_url),t.setBaseUrl(s.base_url),await s.getListsFromAPI(),s.addListenerToActions()},addListenerToActions:function(){document.getElementById("addListButton").addEventListener("click",l.showAddListModal),document.getElementById("handleTagsButton").addEventListener("click",t.showHandleTagsModal);const e=document.getElementsByClassName("close");for(const t of e)t.addEventListener("click",s.hideModals);const a=document.querySelector("#addAndEditTagModal form");console.log(a),a.addEventListener("submit",s.handleAddNewTagForm),document.querySelector("#addListModal form").addEventListener("submit",s.handleAddListForm),document.querySelector("#addCardModal form").addEventListener("submit",s.handleAddCardForm)},hideModals:function(){const e=document.querySelectorAll(".modal");for(const t of e)t.classList.remove("is-active")},handleAddListForm:async function(e){e.preventDefault(),l.handleAddListForm(e),s.hideModals()},handleAddCardForm:async function(e){e.preventDefault(),o.handleAddCardForm(e),s.hideModals()},handleAddNewTagForm:async function(e){e.preventDefault(),t.handleAddNewTagForm(e),s.hideModals()},getListsFromAPI:async function(){try{const e=await fetch(s.base_url+"/list");console.log(e);const a=await e.json();if(console.log(a),200!==e.status)throw a;{for(const r of a){l.makeListInDOM(r);for(const e of r.cards)if(o.makeCardInDOM(e),e.labels)for(const a of e.labels){const o=t.makeTagInDom(a,e.id);document.querySelector(`[card_id="${e.id}"] .tags`).appendChild(o)}}const e=document.querySelector(".card-lists");new Sortable(e,{group:"project",draggable:".panel",onEnd:l.handleDropList})}}catch(e){alert("Impossible de charger les listes depuis l'API"),console.error(e)}}};document.addEventListener("DOMContentLoaded",s.init)}();